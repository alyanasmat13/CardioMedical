<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/x-icon" href="/images/logos/Cardio Only Logo.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register - Cardio Medical</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="scripts/supabase-config.js"></script>
  </head>
  <body>
    <div class="header">
      <a id="cardio" href="index.html">Cardio Medical</a>
      <div class="header-right">
        <a href="index.html">Home</a>
        <a href="team.html">Our Team</a>
        <a href="podcast.html">Podcast</a>
        <a href="#">Resources</a>
        <a href="database.html">Database</a>
        <a href="#">Articles</a>
        <a href="about.html">About Us</a>
      </div>
    </div>
    <div class="logo">
      <img src="images/logos/Cardio Only Logo.png" alt="Cardio Medical Logo"/>
    </div>
    
    <div class="signup-intro">
      <h1>Register</h1>

      <div id="message"></div>

      <form id="signupForm" class="signup-form">

        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" name="fullname" placeholder="Enter Full Name" required>

        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="Enter Email" required>

        <label for="password">Password</label>
        <input type="password" id="password" name="password" placeholder="Enter Password" required>

        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Re-enter Password" required>

        <p>Only authorized members can register.</p>

        <button type="submit" class="signup-btn" id="signupBtn">Create Account</button>
      </form>
    </div>
    <div class="footer">
      <div class="minifooter">
        <a id="footertoptext">Cardio Medical</a>
        <div class="media">
          <div class="social-media">
            <p>Follow Us On Social Media:</p>
            <i class="fa fa-facebook-square"></i>
            <i class="fa fa-instagram"></i>
            <i class="fa fa-linkedin-square"></i>
          </div>
          <div class="contact-info">
            <p>Contact Us!</p>
            <p>Email: <a href="mailto:alyanasmat13@gmail.com">Us Here </a></p>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Cardio Medical. All rights reserved.</p>
      </div>
    </div>
    <script>
        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', async function() {
            const { data: { session } } = await supabase.auth.getSession()
            if (session) {
                // User is already logged in, redirect to blog admin
                window.location.href = 'blog-admin.html';
            }
        });

        // Handle signup form submission
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const fullName = document.getElementById('fullName').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const signupBtn = document.getElementById('signupBtn');

            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('Passwords do not match', 'error');
                return;
            }

            // Update button state
            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';

            try {
                // First check if email is in approved members list
                const memberResult = await checkMembershipStatus(email);
                if (!memberResult.ok) {
                    throw new Error(memberResult.error?.message || 'Membership check failed');
                }
                if (!memberResult.data) {
                    throw new Error('Email not found in approved members list. Please contact an administrator.');
                }
 
                // Create the user account
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: fullName
                        }
                    }
                });

                if (error) {
                    throw error;
                }

                if (data.user && !data.session) {
                    // Email confirmation required
                    showMessage('Registration successful! Please check your email for a confirmation link.', 'success');
                } else if (data.session) {
                    // No email confirmation required, user is logged in
                    showMessage('Account created successfully! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = 'blog-admin.html';
                    }, 2000);
                }

            } catch (error) {
                showMessage('Registration failed: ' + error.message, 'error');
            } finally {
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        });

        // Show message to user
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
        }
    </script>
  </body>
</html>
